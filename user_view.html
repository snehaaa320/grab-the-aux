<!DOCTYPE html>
<html>

<head>

    <!-- <meta http-equiv="content-type" content="text/html; charset=UTF-8"> -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="user_view.js" type="text/javascript"></script>

    <!-- SCRIPTS FOR SEARCH FUNCTIONALITY -->
    <script type="text/javascript" src="https://requirejs.org/docs/release/2.3.6/minified/require.js"></script>
    <script type="text/javascript" src="spotify-web-api-js.js"></script>
    <script type="text/javascript" src="search.js"></script>

    <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.min.js" type="text/javascript"></script>
    <link href="user_view.css" type="text/css" rel="stylesheet">

    <title>Upvote/Downvote</title>

    <!-- TODO: Missing CoffeeScript 2 -->

</head>

<body>

    <div class="top_content">
        <div id="heading">
            <h1>[HOST NAME] PLAYLIST</h1>
        </div>

        <div id="instructions">
            <h2 id="guest_banner">Welcome, [GUEST USER]</h2>
            <script>
                var queryString = decodeURIComponent(window.location.search);
                queryString = queryString.substring(1);
                var queries = queryString.split("&");
                var is_guest = queries[0].split("=")[1];
                var user_name = queries[1].split("=")[1];
                document.getElementById("guest_banner").innerHTML = "Welcome, " + user_name;
            </script>
            <ol>
                <li>Enter in a song suggestion to add to the queue.<br>The host will queue each song into the playlist.</li>
                <li>Scan the list and upvote songs you want to hear.<br>(Downvote ones you don't like)</li>
                <li>Dance to the music being played & wait for yours!</li>
            </ol>
            <p><button type="submit">Got it!</button></p>
        </div>
    </div>

    <hr>

    <div>
        <div class="search_bar">
            <h2>Search (Hosts Only)</h2>


            <form autocomplete="off" accept-charset="utf-8" class="search-container">

                <div class="autocomplete" style="width:300px;">
                    <input id="mysong" type="search" name="mysong" placeholder="Songs" value="">
                </div>

                <!-- <input type="text" id="search-bar" placeholder="Search Your Song"> -->
                <!-- <a href="#"></a> -->

                <script>
                    //token hard coded right now. when we get authorization working it will be passed into the functions

                    var token = 'BQDYwRvWbHIxkgU4UWqgXGYVDzFmxih1y3VleSG7nZgwnYF8EANLk0LhGLgCLIHc7T5lLZX6-2NIZQ_tq1t4rdREM_qhj-Otxtxt5AZos9yP8km9Fevq044kC9luUUGvCRc9XYXUZzCvCDGFFFew61JStqDKateW33l9K-uSwQtBCIEHs57NVUfOM0y_mZPd7-8mJgBuceR9zHCO';
                    var playlistid = '3zCYmXTvVcvrN27SLll5lk';
                    var user_uri = '121444178';
                    var tracks = [];
                    var song = [];
                    var user = "user";
                    var songs = ["Taki Taki - DJ Snake", "Happier - Bastille, Marshmello", "I Like Me Better -Lauv", "Party In The USA- Miley Cyrus", "Wonderwall- Oasis", "Mr. Brightside- The Killers"]
                    autocomplete(document.getElementById("mysong"), songs);

                    //var song = prompt("Please enter a song", "song goes here");
                    function start(token) {
                        var spotifyApi = new SpotifyWebApi();
                        spotifyApi.setAccessToken(token);
                        var s = document.getElementById("mysong").value;

                        spotifyApi.getUser(user_uri)
                            .then(function(data) {
                                console.log('User data:', data);
                                user = data["display_name"];
                                console.log(data["display_name"]);
                            }, function(err) {
                                console.error(err);
                            });



                        //display top 10 tracks
                        spotifyApi.searchTracks(s)
                            .then(function(data) {
                                console.log('Search result:', data);
                                console.log(data["tracks"]["items"][0]["name"]);
                                console.log(data["tracks"]["items"][0]["artists"][0]["name"]);
                                console.log(data["tracks"]["items"][0]["uri"]);

                                var uri = data["tracks"]["items"][0]["uri"];

                                var map = {};
                                song.push(uri);

                                for (var i = 0; i < 3; i++) {
                                    tracks.push(data["tracks"]["items"][i]["uri"]);
                                    var current = data["tracks"]["items"][i]["artists"][0]["name"];

                                    if (data["tracks"]["items"][i]["artists"][0]["name"] == 'null')
                                        break;

                                    map[tracks[i]] = data["tracks"]["items"][i]["name"] + "-" + data["tracks"]["items"][i]["artists"][0]["name"];
                                }

                                document.getElementById('tracks').innerHTML = "<h3> Search Results: </h3>";

                                for (i = 0; i < 3; i++) {
                                    document.getElementById('tracks').innerHTML += map[tracks[i]] + "<br>";
                                }
                                document.getElementById('success').innerHTML = "Success! Your song was found!";

                            }, function(err) {
                                console.error(err);
                            });

                    }

                    function addToPlaylist(song, token) {
                        var spotifyApi = new SpotifyWebApi();
                        spotifyApi.setAccessToken(token);

                        spotifyApi.addTracksToPlaylist(playlistid, song)
                            .then(function(playlist) {
                                console.log('Track added!', playlist);
                            }, function(err) {
                                console.error(err);
                            });
                    }
                </script>

            </form>

            <p><button type="submit" onclick="start(token)">Search</button></p>

            <!-- <img class="search-icon" src="http://www.endlessicons.com/wp-content/uploads/2012/12/search-icon.png"> -->
            <div id="success"></div>
            <div id="tracks"></div>
            <p><button type="submit" onclick="addToPlaylist(song, token)"> Add to Playlist </button></p>



        </div>
    </div>

    <hr>

    <div>
        <div class="guest_form">

            <div id="write_suggestion_div">
                <h2>Suggest Songs</h2>
                <form id="suggestions" method="post">
                    <table style="width:100%;padding:20px;">
                        <tr>
                            <td>Song Title :</td>
                            <td><input id="song_name" type="text" name="song_name" placeholder="Type Song Name..."></td>
                        </tr>
                        <tr>
                            <td>Song Artist :</td>
                            <td><input id="song_artist" type="text" name="song_artist" placeholder="Type Artist Name..."></td>
                        </tr>
                    </table>
                    <button type="submit" name="submit_suggestions" onclick="writeToDB();">Submit Request</button>
                </form>
            </div>

        </div>
    </div>

    <hr>

    <div>
        <div class="suggestion_box">
            <div id="song_div">
                <h2>Current Queue</h2>
                <table id="song_table">
                    <tr>
                        <th>Queue #</th>
                        <th>Song Name</th>
                        <th>Song Artists</th>
                        <th>Votes</th>
                        <th>Song Queued</th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <hr>

    <div>
        <div class="music_player">
            <iframe src="https://open.spotify.com/embed/user/121444178/playlist/3zCYmXTvVcvrN27SLll5lk" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
        </div>
    </div>


    <div id="app">
    </div>

    <div style="text-align: center;">
        <button id="externalButton">Return Home</button>
    </div>
</body>

</html>
